{% extends "base.html" %}

{% block title %}{{ portfolio.name }} - Rebalancing Analysis{% endblock %}

{% block content %}
<!-- Success/Error Messages -->
{% if request.query_params.get('executed') %}
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle"></i>
        Successfully executed {{ request.query_params.get('executed') }} rebalancing transactions.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
{% endif %}

{% if request.query_params.get('error') %}
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle"></i>
        Error: {{ request.query_params.get('error') }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
{% endif %}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1>Rebalancing Analysis</h1>
        <h5 class="text-muted">{{ portfolio.name }}</h5>
    </div>
    
    <div>
        <a href="/portfolios/{{ portfolio.id }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to Portfolio
        </a>
    </div>
</div>

<!-- Rebalancing Status Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h6 class="card-subtitle mb-2 text-muted">Portfolio Status</h6>
                <h4 class="card-title {% if is_balanced %}text-success{% else %}text-warning{% endif %}">
                    {% if is_balanced %}
                        <i class="bi bi-check-circle"></i> Balanced
                    {% else %}
                        <i class="bi bi-exclamation-triangle"></i> Needs Rebalancing
                    {% endif %}
                </h4>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h6 class="card-subtitle mb-2 text-muted">Portfolio Value</h6>
                <h4 class="card-title text-success">${{ "%.2f"|format(total_value) }}</h4>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h6 class="card-subtitle mb-2 text-muted">Transactions Needed</h6>
                <h4 class="card-title {% if transaction_count > 0 %}text-warning{% else %}text-success{% endif %}">
                    {{ transaction_count }}
                </h4>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h6 class="card-subtitle mb-2 text-muted">Estimated Cost</h6>
                <h4 class="card-title text-info">
                    ${{ "%.2f"|format(total_transaction_cost) }}
                    <small class="text-muted d-block">({{ "%.2f"|format(cost_percentage) }}%)</small>
                </h4>
            </div>
        </div>
    </div>
</div>

<!-- Rebalancing Settings -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="bi bi-gear"></i> Rebalancing Settings
        </h5>
    </div>
    <div class="card-body">
        <form id="settingsForm">
            <div class="row">
                <div class="col-md-4">
                    <label for="tolerance" class="form-label">Tolerance Threshold (%)</label>
                    <input type="number" class="form-control" id="tolerance" value="{{ tolerance_threshold }}" 
                           min="0.1" max="10" step="0.1">
                    <small class="form-text text-muted">Holdings outside this threshold will be rebalanced</small>
                </div>
                <div class="col-md-4">
                    <label for="costRate" class="form-label">Transaction Cost Rate (%)</label>
                    <input type="number" class="form-control" id="costRate" value="{{ "%.3f"|format(transaction_cost_rate * 100) }}" 
                           min="0" max="2" step="0.001">
                    <small class="form-text text-muted">Cost as percentage of transaction value</small>
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button type="button" class="btn btn-primary" onclick="refreshAnalysis()">
                        <i class="bi bi-arrow-repeat"></i> Refresh Analysis
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Allocation Comparison -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Current Allocation</h5>
            </div>
            <div class="card-body">
                <canvas id="currentAllocationChart" width="400" height="400"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Target Allocation</h5>
            </div>
            <div class="card-body">
                <canvas id="targetAllocationChart" width="400" height="400"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Allocation Drift Table -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="bi bi-table"></i> Allocation Analysis
        </h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Symbol</th>
                        <th class="text-end">Current %</th>
                        <th class="text-end">Target %</th>
                        <th class="text-end">Drift</th>
                        <th class="text-end">Current Value</th>
                        <th class="text-end">Target Value</th>
                        <th class="text-end">Difference</th>
                        <th class="text-center">Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for drift in allocation_drifts %}
                        <tr>
                            <td><strong>{{ drift.symbol }}</strong></td>
                            <td class="text-end">{{ "%.2f"|format(drift.current_allocation) }}%</td>
                            <td class="text-end">{{ "%.2f"|format(drift.target_allocation) }}%</td>
                            <td class="text-end">
                                <span class="{% if drift.drift > tolerance_threshold %}text-danger{% elif drift.drift < -tolerance_threshold %}text-warning{% else %}text-success{% endif %}">
                                    {{ "%.2f"|format(drift.drift) }}%
                                </span>
                            </td>
                            <td class="text-end">${{ "%.2f"|format(drift.current_value) }}</td>
                            <td class="text-end">${{ "%.2f"|format(drift.target_value) }}</td>
                            <td class="text-end">
                                <span class="{% if drift.value_difference > 0 %}text-success{% else %}text-danger{% endif %}">
                                    ${{ "%.2f"|format(drift.value_difference) }}
                                </span>
                            </td>
                            <td class="text-center">
                                {% if drift.drift|abs > tolerance_threshold %}
                                    <span class="badge bg-warning">Needs Rebalancing</span>
                                {% else %}
                                    <span class="badge bg-success">Balanced</span>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Recommended Transactions -->
{% if transactions %}
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            <i class="bi bi-arrow-left-right"></i> Recommended Transactions
        </h5>
        <div>
            <button type="button" class="btn btn-outline-info btn-sm" onclick="previewExecution()">
                <i class="bi bi-eye"></i> Preview
            </button>
            <button type="button" class="btn btn-warning btn-sm" onclick="executeRebalancing(true)">
                <i class="bi bi-play"></i> Dry Run
            </button>
            <button type="button" class="btn btn-danger btn-sm" onclick="executeRebalancing(false)">
                <i class="bi bi-exclamation-triangle"></i> Execute
            </button>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Symbol</th>
                        <th class="text-center">Action</th>
                        <th class="text-end">Shares</th>
                        <th class="text-end">Price</th>
                        <th class="text-end">Value</th>
                        <th class="text-end">Cost</th>
                        <th>Reason</th>
                    </tr>
                </thead>
                <tbody>
                    {% for tx in transactions %}
                        <tr>
                            <td><strong>{{ tx.symbol }}</strong></td>
                            <td class="text-center">
                                <span class="badge {% if tx.action == 'BUY' %}bg-success{% else %}bg-danger{% endif %}">
                                    {{ tx.action }}
                                </span>
                            </td>
                            <td class="text-end">{{ "%.2f"|format(tx.shares) }}</td>
                            <td class="text-end">${{ "%.2f"|format(tx.current_price) }}</td>
                            <td class="text-end">${{ "%.2f"|format(tx.transaction_value) }}</td>
                            <td class="text-end">${{ "%.2f"|format(tx.transaction_cost) }}</td>
                            <td><small class="text-muted">{{ tx.reason }}</small></td>
                        </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr class="table-info">
                        <td colspan="5"><strong>Total Transaction Cost</strong></td>
                        <td class="text-end"><strong>${{ "%.2f"|format(total_transaction_cost) }}</strong></td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>
{% else %}
<div class="card mb-4">
    <div class="card-body text-center py-4">
        <i class="bi bi-check-circle display-1 text-success"></i>
        <h5 class="mt-3 text-success">Portfolio is Balanced!</h5>
        <p class="text-muted">All holdings are within the tolerance threshold of {{ tolerance_threshold }}%.</p>
    </div>
</div>
{% endif %}

<!-- Execution Confirmation Modal -->
<div class="modal fade" id="confirmationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Rebalancing Execution</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Warning:</strong> This action will modify your portfolio holdings.
                </div>
                <p>You are about to execute <strong id="txCount">0</strong> transactions with a total estimated cost of <strong id="txCost">$0.00</strong>.</p>
                <p>Are you sure you want to proceed?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmExecute">Execute Rebalancing</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let currentChart = null;
let targetChart = null;

document.addEventListener('DOMContentLoaded', function() {
    // Initialize allocation charts
    initializeCharts();
    
    // Auto-dismiss alerts
    setTimeout(function() {
        document.querySelectorAll('.alert-dismissible').forEach(function(alert) {
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
        });
    }, 5000);
});

function initializeCharts() {
    fetch(`/api/rebalancing/portfolios/{{ portfolio.id }}/allocation-chart-data`)
        .then(response => response.json())
        .then(data => {
            createAllocationChart('currentAllocationChart', data.current_allocations, 'Current Allocation');
            createAllocationChart('targetAllocationChart', data.target_allocations, 'Target Allocation');
        })
        .catch(error => {
            console.error('Error loading chart data:', error);
        });
}

function createAllocationChart(canvasId, data, title) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    
    // Destroy existing chart if it exists
    if (canvasId === 'currentAllocationChart' && currentChart) {
        currentChart.destroy();
    } else if (canvasId === 'targetAllocationChart' && targetChart) {
        targetChart.destroy();
    }
    
    const chart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: data.map(item => item.symbol),
            datasets: [{
                data: data.map(item => item.allocation),
                backgroundColor: [
                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                    '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                title: {
                    display: true,
                    text: title
                },
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const symbol = context.label;
                            const percentage = context.parsed.toFixed(1);
                            const value = data[context.dataIndex].value;
                            return `${symbol}: ${percentage}% ($${value.toFixed(2)})`;
                        }
                    }
                }
            }
        }
    });
    
    // Store chart reference
    if (canvasId === 'currentAllocationChart') {
        currentChart = chart;
    } else {
        targetChart = chart;
    }
}

function refreshAnalysis() {
    const tolerance = document.getElementById('tolerance').value;
    const costRate = document.getElementById('costRate').value / 100; // Convert to decimal
    
    // Show loading indicator
    const button = event.target;
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Analyzing...';
    
    // Redirect to refresh the page with new parameters
    window.location.href = `/portfolios/{{ portfolio.id }}/rebalancing?tolerance=${tolerance}&cost_rate=${costRate}`;
}

function previewExecution() {
    const tolerance = document.getElementById('tolerance').value;
    const costRate = document.getElementById('costRate').value / 100;
    
    fetch(`/api/rebalancing/portfolios/{{ portfolio.id }}/rebalance-preview?tolerance=${tolerance}&transaction_cost_rate=${costRate}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        alert(`Preview Results:\n\nTransactions: ${data.impact.transactions_needed}\nTotal Cost: $${data.impact.total_transaction_cost.toFixed(2)} (${data.impact.cost_percentage.toFixed(2)}%)\nValue After: $${data.impact.estimated_final_value.toFixed(2)}`);
    })
    .catch(error => {
        console.error('Error previewing:', error);
        alert('Error loading preview data');
    });
}

function executeRebalancing(dryRun) {
    if (!dryRun) {
        // Show confirmation modal for actual execution
        document.getElementById('txCount').textContent = '{{ transaction_count }}';
        document.getElementById('txCost').textContent = '${{ "%.2f"|format(total_transaction_cost) }}';
        
        const modal = new bootstrap.Modal(document.getElementById('confirmationModal'));
        modal.show();
        
        document.getElementById('confirmExecute').onclick = function() {
            modal.hide();
            performExecution(false);
        };
    } else {
        performExecution(true);
    }
}

function performExecution(dryRun) {
    const tolerance = document.getElementById('tolerance').value;
    const costRate = document.getElementById('costRate').value / 100;
    
    const url = `/api/rebalancing/portfolios/{{ portfolio.id }}/execute?dry_run=${dryRun}&tolerance=${tolerance}&transaction_cost_rate=${costRate}`;
    
    fetch(url, { method: 'POST' })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (dryRun) {
                alert(`Dry Run Results:\n\n${data.message}\nTransactions: ${data.transactions_count}\nTotal Cost: $${data.total_cost.toFixed(2)}`);
            } else {
                window.location.href = `/portfolios/{{ portfolio.id }}/rebalancing?executed=${data.transactions_count}`;
            }
        } else {
            alert(`Error: ${data.error || 'Failed to execute rebalancing'}`);
        }
    })
    .catch(error => {
        console.error('Error executing rebalancing:', error);
        alert('Error executing rebalancing');
    });
}
</script>
{% endblock %}