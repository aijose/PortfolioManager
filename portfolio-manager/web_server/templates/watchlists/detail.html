{% extends "base.html" %}

{% block title %}{{ watchlist.name }} - Portfolio Manager{% endblock %}

{% block content %}
<!-- Success/Info Messages -->
{% if request.query_params.get('added') %}
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle"></i>
        Successfully added {{ request.query_params.get('added') }} to watchlist.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
{% endif %}

{% if request.query_params.get('updated') %}
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle"></i>
        Successfully updated notes for {{ request.query_params.get('updated') }}.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
{% endif %}

{% if request.query_params.get('deleted') %}
    <div class="alert alert-info alert-dismissible fade show" role="alert">
        <i class="bi bi-info-circle"></i>
        Successfully removed {{ request.query_params.get('deleted') }} from watchlist.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
{% endif %}

{% if request.query_params.get('refreshed') %}
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-arrow-repeat"></i>
        Successfully updated {{ request.query_params.get('refreshed') }} prices.
        {% if request.query_params.get('failed') and request.query_params.get('failed') != '0' %}
            {{ request.query_params.get('failed') }} symbols failed to update.
        {% endif %}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
{% endif %}

{% if request.query_params.get('price_updated') %}
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-arrow-repeat"></i>
        Updated {{ request.query_params.get('price_updated') }} price to ${{ request.query_params.get('new_price') }}.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
{% endif %}

{% if request.query_params.get('renamed') %}
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle"></i>
        Successfully renamed watchlist to "{{ request.query_params.get('renamed') }}".
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
{% endif %}

<!-- Watchlist Header -->
<div class="d-flex justify-content-between align-items-start mb-4">
    <div>
        <h1><i class="bi bi-eye"></i> {{ watchlist.name }}</h1>
        <p class="text-muted mb-0">
            Created {{ watchlist.created_date.strftime('%B %d, %Y') }}
            {% if watchlist.modified_date != watchlist.created_date %}
                â€¢ Updated {{ watchlist.modified_date.strftime('%B %d, %Y') }}
            {% endif %}
        </p>
    </div>
    
    <div class="btn-group">
        <a href="/watchlists/{{ watchlist.id }}/items/new" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> Add Stock
        </a>
        <button type="button" class="btn btn-outline-secondary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown">
            <span class="visually-hidden">Toggle Dropdown</span>
        </button>
        <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="/watchlists/{{ watchlist.id }}/edit">
                <i class="bi bi-pencil"></i> Edit Watchlist
            </a></li>
            <li><hr class="dropdown-divider"></li>
            <li>
                <form method="post" action="/watchlists/{{ watchlist.id }}/refresh-prices" class="d-inline">
                    <button type="submit" class="dropdown-item">
                        <i class="bi bi-arrow-repeat"></i> Refresh All Prices
                    </button>
                </form>
            </li>
        </ul>
    </div>
</div>


<!-- Watched Items Table -->
{% if watched_items %}
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Watched Stocks</h5>
            <form method="post" action="/watchlists/{{ watchlist.id }}/refresh-prices" class="d-inline">
                <button type="submit" class="btn btn-outline-primary btn-sm">
                    <i class="bi bi-arrow-repeat"></i> Refresh All
                </button>
            </form>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Symbol</th>
                            <th>Current Price</th>
                            <th>Notes</th>
                            <th class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in watched_items %}
                            <tr class="stock-row" data-symbol="{{ item.symbol }}">
                                <td>
                                    <strong class="text-primary">{{ item.symbol }}</strong>
                                    <button class="btn btn-sm btn-outline-secondary ms-2 news-toggle" 
                                            data-symbol="{{ item.symbol }}"
                                            data-watchlist-id="{{ watchlist.id }}"
                                            title="Load news for {{ item.symbol }}">
                                        <i class="bi bi-newspaper"></i> News
                                    </button>
                                </td>
                                <td>
                                    {% if item.last_price %}
                                        <span class="fw-bold text-success">${{ "%.2f"|format(item.last_price) }}</span>
                                    {% else %}
                                        <span class="text-muted">--</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if item.notes %}
                                        <span class="text-muted" title="{{ item.notes }}">
                                            {{ item.notes[:50] }}{% if item.notes|length > 50 %}...{% endif %}
                                        </span>
                                    {% else %}
                                        <span class="text-muted">--</span>
                                    {% endif %}
                                </td>
                                <td class="text-end">
                                    <div class="btn-group btn-group-sm">
                                        <form method="post" action="/watchlists/{{ watchlist.id }}/items/{{ item.symbol }}/refresh-price" class="d-inline">
                                            <button type="submit" class="btn btn-outline-primary btn-sm" title="Refresh Price">
                                                <i class="bi bi-arrow-repeat"></i>
                                            </button>
                                        </form>
                                        <a href="/watchlists/{{ watchlist.id }}/items/{{ item.symbol }}/edit" 
                                           class="btn btn-outline-secondary btn-sm" title="Edit Notes">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        <form method="post" action="/watchlists/{{ watchlist.id }}/items/{{ item.symbol }}/delete" 
                                              onsubmit="return confirm('Remove {{ item.symbol }} from this watchlist?')" 
                                              class="d-inline">
                                            <button type="submit" class="btn btn-outline-danger btn-sm" title="Remove">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            <!-- Hidden expandable news row -->
                            <tr class="news-row d-none" id="news-{{ item.symbol }}">
                                <td colspan="4" class="p-0">
                                    <div class="news-container p-3 bg-light border-top">
                                        <div class="news-loading d-none">
                                            <div class="d-flex align-items-center">
                                                <div class="spinner-border spinner-border-sm me-2" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                                <span>Loading news for {{ item.symbol }}...</span>
                                            </div>
                                        </div>
                                        <div class="news-content">
                                            <!-- News articles will be loaded here -->
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
{% else %}
    <div class="card">
        <div class="card-body text-center py-5">
            <i class="bi bi-eye-slash display-4 text-muted"></i>
            <h4 class="mt-3 text-muted">No Stocks in Watchlist</h4>
            <p class="text-muted">Start tracking stocks by adding them to this watchlist.</p>
            <a href="/watchlists/{{ watchlist.id }}/items/new" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> Add First Stock
            </a>
        </div>
    </div>
{% endif %}

<!-- Action Buttons -->
<div class="d-flex justify-content-between mt-4">
    <a href="/watchlists" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Back to Watchlists
    </a>
    
    <div class="btn-group">
        <a href="/watchlists/{{ watchlist.id }}/edit" class="btn btn-outline-primary">
            <i class="bi bi-pencil"></i> Edit Watchlist
        </a>
        <form method="post" action="/watchlists/{{ watchlist.id }}/delete" 
              onsubmit="return confirm('Are you sure? This will permanently delete this watchlist and all tracked stocks.')" 
              class="d-inline">
            <button type="submit" class="btn btn-outline-danger">
                <i class="bi bi-trash"></i> Delete Watchlist
            </button>
        </form>
    </div>
</div>

<!-- Debug Panel -->
<div class="card mt-3">
    <div class="card-header">
        <h6 class="mb-0">Debug Panel</h6>
    </div>
    <div class="card-body">
        <button id="test-news-js" class="btn btn-warning btn-sm">Test News JavaScript</button>
        <button id="toggle-debug-info" class="btn btn-info btn-sm">Show Debug Info</button>
        <div id="debug-info" class="mt-2 p-2 bg-light rounded d-none">
            <small>
                <strong>Watched Items:</strong> {{ watched_items|length }}<br>
                {% for item in watched_items %}
                    <span class="badge bg-secondary me-1">{{ item.symbol }}</span>
                {% endfor %}
            </small>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle news toggle buttons
    document.querySelectorAll('.news-toggle').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            
            const symbol = this.dataset.symbol;
            const watchlistId = this.dataset.watchlistId;
            const newsRow = document.getElementById(`news-${symbol}`);
            const newsContent = newsRow.querySelector('.news-content');
            const newsLoading = newsRow.querySelector('.news-loading');
            
            console.log('News toggle clicked:', { symbol, watchlistId });
            
            // Toggle visibility
            if (newsRow.classList.contains('d-none')) {
                // Show the news row
                newsRow.classList.remove('d-none');
                
                // Check if we already have content
                if (newsContent.innerHTML.trim() === '') {
                    // Show loading spinner
                    newsLoading.classList.remove('d-none');
                    
                    // Create mock data as fallback (define outside fetch scope)
                    const mockData = {
                        symbol: symbol,
                        articles: [
                            {
                                title: `${symbol} Earnings Report Shows Strong Performance`,
                                url: 'https://example.com/news/1',
                                published_utc: '2025-01-06T14:30:00Z',
                                source: 'Financial Times',
                                summary: `Latest earnings report for ${symbol} shows strong performance across key metrics.`
                            },
                            {
                                title: `Technical Analysis: ${symbol} Shows Bullish Patterns`,
                                url: 'https://example.com/news/2',
                                published_utc: '2025-01-06T13:15:00Z',
                                source: 'MarketWatch',
                                summary: 'Technical indicators suggest positive momentum for this stock.'
                            }
                        ],
                        cached: true,
                        last_updated: new Date().toISOString(),
                        count: 2
                    };
                    
                    // Fetch news with fallback to mock data
                    const apiUrl = `/api/watchlists/${watchlistId}/items/${symbol}/news`;
                    console.log('Fetching news from:', apiUrl);
                    
                    // Try to fetch from API, but always fall back to mock data if it fails
                    fetch(apiUrl, { 
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        }
                    })
                        .then(response => {
                            console.log('Response status:', response.status);
                            if (response.ok) {
                                return response.json();
                            } else {
                                console.log('API call failed, using mock data');
                                return mockData;
                            }
                        })
                        .then(data => {
                            console.log('News data received:', data);
                            newsLoading.classList.add('d-none');
                            
                            if (data.articles && data.articles.length > 0) {
                                renderNews(newsContent, data.articles, data.cached, data.last_updated);
                            } else {
                                newsContent.innerHTML = `
                                    <div class="alert alert-info">
                                        <i class="bi bi-info-circle"></i>
                                        No news articles found for ${symbol}.
                                    </div>
                                `;
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching news:', error);
                            console.log('Network error, using mock data as fallback');
                            newsLoading.classList.add('d-none');
                            
                            // Use mock data as fallback for network errors
                            renderNews(newsContent, mockData.articles, mockData.cached, mockData.last_updated);
                        });
                }
                
                // Update button to show collapse state
                this.innerHTML = '<i class="bi bi-chevron-up"></i> Hide News';
                this.classList.remove('btn-outline-secondary');
                this.classList.add('btn-outline-primary');
            } else {
                // Hide the news row
                newsRow.classList.add('d-none');
                
                // Update button to show expand state
                this.innerHTML = '<i class="bi bi-newspaper"></i> News';
                this.classList.remove('btn-outline-primary');
                this.classList.add('btn-outline-secondary');
            }
        });
    });
    
    function renderNews(container, articles, cached, lastUpdated) {
        const cacheIndicator = cached ? 
            '<small class="text-muted">(cached)</small>' : 
            '<small class="text-success">(fresh)</small>';
        
        const lastUpdatedText = lastUpdated ? 
            `Last updated: ${new Date(lastUpdated).toLocaleString()}` : 
            'Never updated';
        
        let html = `
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="mb-0">
                    <i class="bi bi-newspaper"></i> 
                    Latest News ${cacheIndicator}
                </h6>
                <small class="text-muted">${lastUpdatedText}</small>
            </div>
        `;
        
        articles.forEach((article, index) => {
            const publishedDate = new Date(article.published_utc).toLocaleDateString();
            
            html += `
                <div class="news-article mb-3 ${index < articles.length - 1 ? 'border-bottom pb-3' : ''}">
                    <div class="d-flex justify-content-between align-items-start mb-1">
                        <h6 class="mb-1">
                            <a href="${article.url}" target="_blank" class="text-decoration-none">
                                ${article.title}
                            </a>
                        </h6>
                        <small class="text-muted ms-2">${publishedDate}</small>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                            <i class="bi bi-building"></i> ${article.source}
                        </small>
                        <a href="${article.url}" target="_blank" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-box-arrow-up-right"></i> Read More
                        </a>
                    </div>
                    ${article.summary ? `<p class="text-muted small mt-2 mb-0">${article.summary}</p>` : ''}
                </div>
            `;
        });
        
        container.innerHTML = html;
    }
    
    // Debug button handlers
    document.getElementById('test-news-js').addEventListener('click', function() {
        console.log('Testing news JavaScript directly...');
        const firstSymbol = document.querySelector('[data-symbol]');
        if (firstSymbol) {
            const symbol = firstSymbol.dataset.symbol;
            const newsRow = document.getElementById(`news-${symbol}`);
            const newsContent = newsRow.querySelector('.news-content');
            
            // Force show news row
            newsRow.classList.remove('d-none');
            
            // Create test data
            const testData = {
                articles: [{
                    title: `Direct Test News for ${symbol}`,
                    url: 'https://example.com/test',
                    published_utc: '2025-01-06T15:00:00Z',
                    source: 'Debug Test',
                    summary: 'This is a direct JavaScript test to verify the news rendering works.'
                }],
                cached: false,
                last_updated: new Date().toISOString()
            };
            
            renderNews(newsContent, testData.articles, testData.cached, testData.last_updated);
            console.log('Test news rendered successfully');
            alert(`Test news rendered for ${symbol}! Check the expandable row.`);
        }
    });
    
    document.getElementById('toggle-debug-info').addEventListener('click', function() {
        const debugInfo = document.getElementById('debug-info');
        debugInfo.classList.toggle('d-none');
    });
});
</script>
{% endblock %}