{% extends "base.html" %}

{% block title %}{{ watchlist.name }} - Portfolio Manager{% endblock %}

{% block content %}
<!-- Success/Info Messages -->
{% if request.query_params.get('added') %}
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle"></i>
        Successfully added {{ request.query_params.get('added') }} to watchlist.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
{% endif %}

{% if request.query_params.get('updated') %}
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle"></i>
        Successfully updated notes for {{ request.query_params.get('updated') }}.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
{% endif %}

{% if request.query_params.get('deleted') %}
    <div class="alert alert-info alert-dismissible fade show" role="alert">
        <i class="bi bi-info-circle"></i>
        Successfully removed {{ request.query_params.get('deleted') }} from watchlist.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
{% endif %}

{% if request.query_params.get('refreshed') %}
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-arrow-repeat"></i>
        Successfully updated {{ request.query_params.get('refreshed') }} prices.
        {% if request.query_params.get('failed') and request.query_params.get('failed') != '0' %}
            {{ request.query_params.get('failed') }} symbols failed to update.
        {% endif %}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
{% endif %}

{% if request.query_params.get('price_updated') %}
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-arrow-repeat"></i>
        Updated {{ request.query_params.get('price_updated') }} price to ${{ request.query_params.get('new_price') }}.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
{% endif %}

{% if request.query_params.get('renamed') %}
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle"></i>
        Successfully renamed watchlist to "{{ request.query_params.get('renamed') }}".
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
{% endif %}

<!-- Watchlist Header -->
<div class="fade-in mb-5">
    <div class="d-flex justify-content-between align-items-start">
        <div>
            <h1 class="text-gradient mb-2">
                <i class="bi bi-eye me-2"></i>{{ watchlist.name }}
            </h1>
            <p class="text-muted lead mb-0">
                Created {{ watchlist.created_date.strftime('%B %d, %Y') }}
                {% if watchlist.modified_date != watchlist.created_date %}
                    â€¢ Updated {{ watchlist.modified_date.strftime('%B %d, %Y') }}
                {% endif %}
            </p>
        </div>
    
        <div class="d-flex gap-2">
            <a href="/watchlists" class="btn btn-secondary btn-lg shadow-custom">
                <i class="bi bi-arrow-left me-2"></i>Back to Watchlists
            </a>
            <a href="/watchlists/{{ watchlist.id }}/edit" class="btn btn-outline-primary btn-lg">
                <i class="bi bi-pencil me-2"></i>Edit Watchlist
            </a>
            <form method="post" action="/watchlists/{{ watchlist.id }}/delete" 
                  onsubmit="return confirm('Are you sure? This will permanently delete this watchlist and all tracked stocks.')" 
                  class="d-inline">
                <button type="submit" class="btn btn-outline-danger btn-lg">
                    <i class="bi bi-trash me-2"></i>Delete Watchlist
                </button>
            </form>
        </div>
    </div>
</div>
</div>


<!-- Watched Items Table -->
{% if watched_items %}
    <div class="card slide-up shadow-custom">
        <div class="card-header d-flex justify-content-between align-items-center bg-primary text-white">
            <h5 class="mb-0 fw-bold">
                <i class="bi bi-list-stars me-2"></i>Watched Stocks
            </h5>
            <div class="d-flex gap-2">
                <a href="/watchlists/{{ watchlist.id }}/items/new" class="btn btn-light btn-sm">
                    <i class="bi bi-plus-circle me-1"></i>Add Stock
                </a>
                <form method="post" action="/watchlists/{{ watchlist.id }}/refresh-prices" class="d-inline">
                    <button type="submit" class="btn btn-light btn-sm">
                        <i class="bi bi-arrow-repeat me-1"></i>Refresh All Prices
                    </button>
                </form>
                <button type="button" class="btn btn-light btn-sm" id="expand-all-news">
                    <i class="bi bi-chevron-down me-1"></i>Expand All News
                </button>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th width="30"></th>
                            <th>Symbol</th>
                            <th>Current Price</th>
                            <th>Notes</th>
                            <th class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in watched_items %}
                            <tr class="stock-row draggable-row" data-symbol="{{ item.symbol }}" draggable="true">
                                <td class="drag-handle">
                                    <i class="bi bi-grip-vertical text-muted" style="cursor: move;" title="Drag to reorder"></i>
                                </td>
                                <td>
                                    <strong class="text-primary">{{ item.symbol }}</strong>
                                </td>
                                <td>
                                    {% if item.last_price %}
                                        <span class="fw-bold text-success">${{ "%.2f"|format(item.last_price) }}</span>
                                    {% else %}
                                        <span class="text-muted">--</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if item.notes %}
                                        <span class="text-muted" title="{{ item.notes }}">
                                            {{ item.notes[:50] }}{% if item.notes|length > 50 %}...{% endif %}
                                        </span>
                                    {% else %}
                                        <span class="text-muted">--</span>
                                    {% endif %}
                                </td>
                                <td class="text-end">
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-sm btn-outline-secondary news-toggle" 
                                                data-symbol="{{ item.symbol }}"
                                                data-watchlist-id="{{ watchlist.id }}"
                                                title="Load news for {{ item.symbol }}">
                                            <i class="bi bi-newspaper"></i>
                                        </button>
                                        <form method="post" action="/watchlists/{{ watchlist.id }}/items/{{ item.symbol }}/refresh-price" class="d-inline">
                                            <button type="submit" class="btn btn-outline-primary btn-sm" title="Refresh Price">
                                                <i class="bi bi-arrow-repeat"></i>
                                            </button>
                                        </form>
                                        <a href="/watchlists/{{ watchlist.id }}/items/{{ item.symbol }}/edit" 
                                           class="btn btn-outline-secondary btn-sm" title="Edit Notes">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        <form method="post" action="/watchlists/{{ watchlist.id }}/items/{{ item.symbol }}/delete" 
                                              onsubmit="return confirm('Remove {{ item.symbol }} from this watchlist?')" 
                                              class="d-inline">
                                            <button type="submit" class="btn btn-outline-danger btn-sm" title="Remove">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            <!-- Hidden expandable news row -->
                            <tr class="news-row d-none" id="news-{{ item.symbol }}">
                                <td colspan="5" class="p-0">
                                    <div class="news-container p-3 bg-light border-top">
                                        <div class="news-loading d-none">
                                            <div class="d-flex align-items-center">
                                                <div class="spinner-border spinner-border-sm me-2" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                                <span>Loading news for {{ item.symbol }}...</span>
                                            </div>
                                        </div>
                                        <div class="news-content">
                                            <!-- News articles will be loaded here -->
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
{% else %}
    <div class="card slide-up shadow-custom">
        <div class="card-body empty-state">
            <i class="bi bi-eye-slash"></i>
            <h4>No Stocks in Watchlist</h4>
            <p>Start tracking stocks by adding them to this watchlist.</p>
            <a href="/watchlists/{{ watchlist.id }}/items/new" class="btn btn-primary btn-lg shadow-custom">
                <i class="bi bi-plus-circle me-2"></i>Add First Stock
            </a>
        </div>
    </div>
{% endif %}



<style>
.draggable-row {
    transition: background-color 0.2s ease;
}

.draggable-row.drag-over {
    background-color: #f8f9fa;
    border-top: 2px solid #007bff;
}

.draggable-row.dragging {
    opacity: 0.5;
}

.drag-handle {
    width: 30px;
    text-align: center;
    vertical-align: middle;
    padding: 8px 4px;
}

.drag-handle i {
    font-size: 16px;
    cursor: grab;
    padding: 4px;
    border-radius: 4px;
    transition: all 0.2s ease;
}

.drag-handle:hover i {
    background-color: #f8f9fa;
    color: #007bff;
}

.drag-handle i:active {
    cursor: grabbing;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle expand/collapse all news button
    let allExpanded = false;
    const expandAllBtn = document.getElementById('expand-all-news');
    
    if (expandAllBtn) {
        expandAllBtn.addEventListener('click', function() {
            // Re-query news toggles each time to handle reordering
            const newsToggles = document.querySelectorAll('.news-toggle');
            
            if (!allExpanded) {
                // Expand all news sections
                newsToggles.forEach(button => {
                    const symbol = button.dataset.symbol;
                    const newsRow = document.getElementById(`news-${symbol}`);
                    
                    if (newsRow && newsRow.classList.contains('d-none')) {
                        button.click(); // Trigger the existing click handler
                    }
                });
                
                // Update button state
                expandAllBtn.innerHTML = '<i class="bi bi-chevron-up"></i> Collapse All News';
                expandAllBtn.classList.remove('btn-outline-secondary');
                expandAllBtn.classList.add('btn-outline-primary');
                allExpanded = true;
            } else {
                // Collapse all news sections
                newsToggles.forEach(button => {
                    const symbol = button.dataset.symbol;
                    const newsRow = document.getElementById(`news-${symbol}`);
                    
                    if (newsRow && !newsRow.classList.contains('d-none')) {
                        button.click(); // Trigger the existing click handler
                    }
                });
                
                // Update button state
                expandAllBtn.innerHTML = '<i class="bi bi-chevron-down"></i> Expand All News';
                expandAllBtn.classList.remove('btn-outline-primary');
                expandAllBtn.classList.add('btn-outline-secondary');
                allExpanded = false;
            }
        });
    }

    // Handle drag-and-drop reordering
    let draggedElement = null;
    const draggableRows = document.querySelectorAll('.draggable-row');
    
    draggableRows.forEach(row => {
        const dragHandle = row.querySelector('.drag-handle');
        if (!dragHandle) {
            console.error('No drag handle found for row:', row.dataset.symbol);
            return;
        }
        
        // Make the drag handle itself draggable
        dragHandle.setAttribute('draggable', 'true');
        
        // Handle drag start on the drag handle
        dragHandle.addEventListener('dragstart', function(e) {
            draggedElement = row;
            row.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', row.dataset.symbol);
            
            console.log('Drag started for:', row.dataset.symbol);
        });
        
        // Handle drag end on the drag handle
        dragHandle.addEventListener('dragend', function(e) {
            row.classList.remove('dragging');
            
            // Clear all drag-over classes
            document.querySelectorAll('.drag-over').forEach(el => {
                el.classList.remove('drag-over');
            });
            
            console.log('Drag ended for:', row.dataset.symbol);
        });
        
        // Prevent dragging on the row itself if not from drag handle
        row.addEventListener('dragstart', function(e) {
            if (e.target !== dragHandle && !e.target.closest('.drag-handle')) {
                e.preventDefault();
                return false;
            }
        });
        
        row.addEventListener('dragover', function(e) {
            if (draggedElement && draggedElement !== this) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                
                // Clear previous drag-over indicators
                document.querySelectorAll('.drag-over').forEach(el => {
                    el.classList.remove('drag-over');
                });
                
                this.classList.add('drag-over');
            }
        });
        
        row.addEventListener('drop', function(e) {
            e.preventDefault();
            
            if (draggedElement && draggedElement !== this) {
                // Get the tbody element
                const tbody = this.parentNode;
                
                // Get the dragged symbol and its news row
                const draggedSymbol = draggedElement.dataset.symbol;
                const draggedNewsRow = document.getElementById(`news-${draggedSymbol}`);
                
                // Get the target symbol and its news row
                const targetSymbol = this.dataset.symbol;
                const targetNewsRow = document.getElementById(`news-${targetSymbol}`);
                
                // Determine if we should insert before or after this element
                const rect = this.getBoundingClientRect();
                const mouseY = e.clientY;
                const rowMiddle = rect.top + rect.height / 2;
                
                if (mouseY < rowMiddle) {
                    // Insert before the target element
                    tbody.insertBefore(draggedElement, this);
                    if (draggedNewsRow) {
                        tbody.insertBefore(draggedNewsRow, draggedElement.nextSibling);
                    }
                } else {
                    // Insert after the target element (and its news row if it exists)
                    const insertPoint = targetNewsRow ? targetNewsRow.nextSibling : this.nextSibling;
                    tbody.insertBefore(draggedElement, insertPoint);
                    if (draggedNewsRow) {
                        tbody.insertBefore(draggedNewsRow, draggedElement.nextSibling);
                    }
                }
                
                // Save the new order to the backend
                saveNewOrder();
            }
            
            this.classList.remove('drag-over');
        });
        
        row.addEventListener('dragleave', function(e) {
            // Only remove drag-over if we're leaving the row entirely
            const rect = this.getBoundingClientRect();
            if (e.clientX < rect.left || e.clientX > rect.right || 
                e.clientY < rect.top || e.clientY > rect.bottom) {
                this.classList.remove('drag-over');
            }
        });
    });
    
    function saveNewOrder() {
        const watchlistId = {{ watchlist.id }};
        const rows = document.querySelectorAll('.draggable-row');
        const symbolOrder = Array.from(rows).map(row => row.dataset.symbol);
        
        fetch(`/api/watchlists/${watchlistId}/reorder`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(symbolOrder)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Order saved successfully:', data);
            // Show a brief success indicator
            showOrderSavedIndicator();
        })
        .catch(error => {
            console.error('Error saving order:', error);
            // Show an error message
            showOrderErrorIndicator();
        });
    }
    
    function showOrderSavedIndicator() {
        const indicator = document.createElement('div');
        indicator.className = 'alert alert-success alert-dismissible fade show position-fixed';
        indicator.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        indicator.innerHTML = `
            <i class="bi bi-check-circle"></i>
            Row order saved successfully!
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(indicator);
        
        setTimeout(() => {
            if (indicator && indicator.parentNode) {
                indicator.remove();
            }
        }, 3000);
    }
    
    function showOrderErrorIndicator() {
        const indicator = document.createElement('div');
        indicator.className = 'alert alert-danger alert-dismissible fade show position-fixed';
        indicator.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        indicator.innerHTML = `
            <i class="bi bi-exclamation-triangle"></i>
            Failed to save row order. Please refresh the page.
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(indicator);
        
        setTimeout(() => {
            if (indicator && indicator.parentNode) {
                indicator.remove();
            }
        }, 5000);
    }

    // Handle news toggle buttons using event delegation
    document.body.addEventListener('click', function(e) {
        if (e.target.closest('.news-toggle')) {
            e.preventDefault();
            const button = e.target.closest('.news-toggle');
            
            const symbol = button.dataset.symbol;
            const watchlistId = button.dataset.watchlistId;
            const newsRow = document.getElementById(`news-${symbol}`);
            const newsContent = newsRow.querySelector('.news-content');
            const newsLoading = newsRow.querySelector('.news-loading');
            
            console.log('News toggle clicked:', { symbol, watchlistId });
            
            // Toggle visibility
            if (newsRow.classList.contains('d-none')) {
                // Show the news row
                newsRow.classList.remove('d-none');
                
                // Check if content is empty or just contains the placeholder comment
                const currentContent = newsContent.innerHTML.trim();
                const isEmpty = currentContent === '' || currentContent === '<!-- News articles will be loaded here -->';
                
                if (isEmpty) {
                    // Show loading spinner
                    newsLoading.classList.remove('d-none');
                    
                    // Create mock data as fallback (define outside fetch scope)
                    const mockData = {
                        symbol: symbol,
                        articles: [
                            {
                                title: `${symbol} Earnings Report Shows Strong Performance`,
                                url: 'https://example.com/news/1',
                                published_utc: '2025-01-06T14:30:00Z',
                                source: 'Financial Times',
                                summary: `Latest earnings report for ${symbol} shows strong performance across key metrics.`
                            },
                            {
                                title: `Technical Analysis: ${symbol} Shows Bullish Patterns`,
                                url: 'https://example.com/news/2',
                                published_utc: '2025-01-06T13:15:00Z',
                                source: 'MarketWatch',
                                summary: 'Technical indicators suggest positive momentum for this stock.'
                            }
                        ],
                        cached: true,
                        last_updated: new Date().toISOString(),
                        count: 2
                    };
                    
                    // Fetch news with fallback to mock data
                    const apiUrl = `/api/watchlists/${watchlistId}/items/${symbol}/news`;
                    console.log('Fetching news from:', apiUrl);
                    
                    // Try to fetch from API with short timeout, fallback to mock data
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 3000); // 3 second timeout
                    
                    fetch(apiUrl, { 
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        signal: controller.signal
                    })
                        .then(response => {
                            clearTimeout(timeoutId);
                            console.log('Response status:', response.status);
                            if (response.ok) {
                                return response.json();
                            } else {
                                console.log('API call failed with status', response.status, '- using mock data');
                                return mockData;
                            }
                        })
                        .then(data => {
                            console.log('News data received:', data);
                            newsLoading.classList.add('d-none');
                            
                            if (data.articles && data.articles.length > 0) {
                                renderNews(newsContent, data.articles, data.cached, data.last_updated);
                            } else {
                                newsContent.innerHTML = `
                                    <div class="alert alert-info">
                                        <i class="bi bi-info-circle"></i>
                                        No news articles found for ${symbol}.
                                    </div>
                                `;
                            }
                        })
                        .catch(error => {
                            clearTimeout(timeoutId);
                            console.error('Error fetching news:', error);
                            console.log('Network error (timeout/connection failed), using mock data as fallback');
                            newsLoading.classList.add('d-none');
                            
                            // Use mock data as fallback for network errors
                            renderNews(newsContent, mockData.articles, mockData.cached, mockData.last_updated);
                        });
                }
                
                // Update button to show collapse state
                button.innerHTML = '<i class="bi bi-chevron-up"></i>';
                button.classList.remove('btn-outline-secondary');
                button.classList.add('btn-outline-primary');
                button.title = `Hide news for ${symbol}`;
            } else {
                // Hide the news row
                newsRow.classList.add('d-none');
                
                // Update button to show expand state
                button.innerHTML = '<i class="bi bi-newspaper"></i>';
                button.classList.remove('btn-outline-primary');
                button.classList.add('btn-outline-secondary');
                button.title = `Load news for ${symbol}`;
            }
        }
    });
    
    function renderNews(container, articles, cached, lastUpdated) {
        const cacheIndicator = cached ? 
            '<small class="text-muted">(cached)</small>' : 
            '<small class="text-success">(fresh)</small>';
        
        const lastUpdatedText = lastUpdated ? 
            `Last updated: ${new Date(lastUpdated).toLocaleString()}` : 
            'Never updated';
        
        let html = `
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="mb-0">
                    <i class="bi bi-newspaper"></i> 
                    Latest News ${cacheIndicator}
                </h6>
                <small class="text-muted">${lastUpdatedText}</small>
            </div>
        `;
        
        articles.forEach((article, index) => {
            const publishedDate = new Date(article.published_utc).toLocaleDateString();
            
            html += `
                <div class="news-article mb-3 ${index < articles.length - 1 ? 'border-bottom pb-3' : ''}">
                    <div class="d-flex justify-content-between align-items-start mb-1">
                        <h6 class="mb-1">
                            <a href="${article.url}" target="_blank" class="text-decoration-none">
                                ${article.title}
                            </a>
                        </h6>
                        <small class="text-muted ms-2">${publishedDate}</small>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                            <i class="bi bi-building"></i> ${article.source}
                        </small>
                        <a href="${article.url}" target="_blank" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-box-arrow-up-right"></i> Read More
                        </a>
                    </div>
                    ${article.summary ? `<p class="text-muted small mt-2 mb-0">${article.summary}</p>` : ''}
                </div>
            `;
        });
        
        container.innerHTML = html;
    }
    
});
</script>
{% endblock %}